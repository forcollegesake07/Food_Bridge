<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FoodBridge Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<script src="https://cdn.tailwindcss.com"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<header class="bg-gray-900 text-white p-4 flex justify-between items-center">
  <h1 class="font-bold text-xl">FoodBridge Admin Panel</h1>
  <button onclick="logout()" class="bg-red-600 px-4 py-1 rounded">Logout</button>
</header>

<main class="p-6 space-y-10">

<!-- USERS -->
<section class="bg-white p-6 rounded-xl shadow">
<h2 class="text-lg font-bold mb-4">User Management</h2>
<table class="w-full text-sm">
<thead class="border-b">
<tr>
<th>Name</th><th>Role</th><th>Trust</th><th>Warnings</th><th>Status</th><th>Actions</th>
</tr>
</thead>
<tbody id="usersTable"></tbody>
</table>
</section>

<!-- DONATIONS -->
<section class="bg-white p-6 rounded-xl shadow">
<h2 class="text-lg font-bold mb-4">Donations</h2>
<table class="w-full text-sm">
<thead class="border-b">
<tr>
<th>Food</th><th>Status</th><th>Restaurant</th><th>Action</th>
</tr>
</thead>
<tbody id="donationsTable"></tbody>
</table>
</section>

<!-- ISSUES -->
<section class="bg-white p-6 rounded-xl shadow">
<h2 class="text-lg font-bold mb-4">Reported Issues</h2>
<ul id="issuesList" class="space-y-2 text-sm"></ul>
</section>

<!-- BROADCAST -->
<section class="bg-white p-6 rounded-xl shadow">
<h2 class="text-lg font-bold mb-4">Broadcast Message</h2>
<textarea id="broadcastMsg" class="w-full border p-2 rounded" rows="3"></textarea>
<button onclick="sendBroadcast()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded">Send</button>
</section>

<!-- LOGS -->
<section class="bg-white p-6 rounded-xl shadow">
<h2 class="text-lg font-bold mb-4">Admin Audit Logs</h2>
<ul id="adminLogs" class="text-sm space-y-1"></ul>
</section>

</main>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDB-qF6Ac93Tj3LR3DI6aTuUtkFNRMDai0",
  authDomain: "panel-9e1a6.firebaseapp.com",
  projectId: "panel-9e1a6"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();
let currentUser;

/* AUTH */
auth.onAuthStateChanged(async user => {
  if (!user) return location.href = "/login";
  const snap = await db.collection("users").doc(user.uid).get();
  if (!snap.exists || snap.data().role !== "admin") {
    alert("Access denied");
    return location.href = "/";
  }
  currentUser = user;
  loadUsers();
  loadDonations();
  loadIssues();
  loadLogs();
});

/* USERS */
function loadUsers(){
  db.collection("users").onSnapshot(snap=>{
    usersTable.innerHTML="";
    snap.forEach(doc=>{
      const u=doc.data();
      usersTable.innerHTML+=`
      <tr class="border-b">
        <td>${u.name||"-"}</td>
        <td>${u.role}</td>
        <td>${u.trustScore??100}</td>
        <td>${u.warnings??0}</td>
        <td>${u.isDisabled?"‚ùå":"‚úÖ"}</td>
        <td>
          <button onclick="trust('${doc.id}',10)">+T</button>
          <button onclick="trust('${doc.id}',-10)">-T</button>
          <button onclick="toggleUser('${doc.id}',${!!u.isDisabled})">
            ${u.isDisabled?"Enable":"Disable"}
          </button>
        </td>
      </tr>`;
    });
  });
}

function trust(id,val){
  db.collection("users").doc(id)
    .update({trustScore:firebase.firestore.FieldValue.increment(val)});
  log("TRUST_CHANGE",id,val);
}

function toggleUser(id,disabled){
  const r = disabled?"":prompt("Reason?");
  db.collection("users").doc(id)
    .update({isDisabled:!disabled,disabledReason:r});
  log(disabled?"ENABLE_USER":"DISABLE_USER",id,r);
}

/* DONATIONS */
function loadDonations(){
  db.collection("donations").orderBy("createdAt","desc").limit(30)
  .onSnapshot(snap=>{
    donationsTable.innerHTML="";
    snap.forEach(doc=>{
      const d=doc.data();
      donationsTable.innerHTML+=`
      <tr class="border-b">
        <td>${d.foodName}</td>
        <td>${d.status}</td>
        <td>${d.restaurantName}</td>
        <td>
          <button onclick="forceDonation('${doc.id}','CancelledByAdmin')"
          class="text-red-600">Cancel</button>
        </td>
      </tr>`;
    });
  });
}

function forceDonation(id,status){
  const note=prompt("Admin note");
  db.collection("donations").doc(id).update({
    status,adminNote:note,adminActionAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  log("FORCE_DONATION",id,status);
}

/* ISSUES */
function loadIssues(){
  db.collection("donations").where("status","==","Issue")
  .onSnapshot(snap=>{
    issuesList.innerHTML="";
    snap.forEach(doc=>{
      const d=doc.data();
      issuesList.innerHTML+=`<li>‚ö† ${d.foodName} ‚Äî ${d.reportReason||""}</li>`;
    });
  });
}

/* BROADCAST */
async function sendBroadcast(){
  const msg=document.getElementById("broadcastMsg").value;
  if(!msg) return;
  await fetch("/api/admin-broadcast",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({message:msg})
  });
  alert("Broadcast sent");
  document.getElementById("broadcastMsg").value="";
}

/* LOGS */
function log(action,target,reason=""){
  db.collection("adminLogs").add({
    adminId:currentUser.uid,action,target,reason,
    timestamp:firebase.firestore.FieldValue.serverTimestamp()
  });
}

function loadLogs(){
  db.collection("adminLogs").orderBy("timestamp","desc").limit(30)
  .onSnapshot(snap=>{
    adminLogs.innerHTML="";
    snap.forEach(d=>{
      const l=d.data();
      adminLogs.innerHTML+=`<li>üõ† ${l.action} ‚Üí ${l.target}</li>`;
    });
  });
}

function logout(){
  auth.signOut().then(()=>location.href="/");
}
</script>

</body>
</html>
