<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Login | FoodBridge</title>

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 576 512'%3E%3Cpath fill='%23F97316' d='M148 76.6C148 34.3 182.3 0 224.6 0c20.3 0 39.8 8.1 54.1 22.4l9.3 9.3 9.3-9.3C311.6 8.1 331.1 0 351.4 0C393.7 0 428 34.3 428 76.6c0 21.2-8.4 41.5-23.4 56.5L288 249.7 171.4 133.1C156.4 118.1 148 97.8 148 76.6zm338.9 239.3l-20.1-20.1c-4.7-4.7-12.3-4.7-17 0L288 457.6 126.1 295.8c-4.7-4.7-12.3-4.7-17 0L89 315.9c-25 25-25 65.5 0 90.5L253.3 570.8c19.1 19.1 50.3 19.1 69.4 0l164.2-164.2c25-25 25-65.5 0-90.5z'/%3E%3C/svg%3E">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Poppins', 'sans-serif'] },
          colors: { brand: { orange: '#F97316', green: '#10B981', dark: '#1F2937' } }
        }
      }
    }
  </script>

  <style>
    .fixed-bg-layer {
      position: fixed;
      inset: 0;
      z-index: -1;
      background-image: linear-gradient(rgba(0,0,0,.6), rgba(0,0,0,.7)),
        url('https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=2070&auto=format&fit=crop');
      background-size: cover;
      background-position: center;
    }
    body { overscroll-behavior-y: none; }
    input { font-size: 16px; }
  </style>
</head>

<body class="min-h-screen flex flex-col font-sans">
<div class="fixed-bg-layer"></div>

<!-- NAV -->
<nav class="bg-white/95 backdrop-blur-md shadow fixed w-full z-50 px-4 py-3 flex justify-between items-center">
  <a href="index" class="flex items-center gap-2 font-bold text-lg text-brand-dark">
    <i class="fa-solid fa-hand-holding-heart text-brand-orange"></i> FoodBridge
  </a>
  <a href="index" class="text-sm font-bold text-gray-600 hover:text-brand-orange">
    <i class="fa-solid fa-arrow-left mr-1"></i> Home
  </a>
</nav>

<!-- AUTH -->
<div class="flex-grow flex items-center justify-center pt-28 px-4">
  <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl overflow-hidden">

    <div class="bg-brand-orange p-6 text-center text-white">
      <h2 class="text-3xl font-bold">Welcome</h2>
      <p id="header-subtitle" class="text-sm mt-1">Sign in to continue</p>
    </div>

    <div class="flex bg-gray-50 border-b">
      <button id="tab-login" onclick="toggleView('login')" class="w-1/2 py-3 font-bold border-b-2 border-brand-orange text-brand-orange">LOG IN</button>
      <button id="tab-signup" onclick="toggleView('signup')" class="w-1/2 py-3 font-bold text-gray-400">SIGN UP</button>
    </div>

    <div class="p-6">

      <!-- LOGIN -->
      <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
        <input id="login-email" type="email" required placeholder="Email"
          class="w-full px-4 py-3 bg-gray-50 border rounded-xl">
        <input id="login-password" type="password" required placeholder="Password"
          class="w-full px-4 py-3 bg-gray-50 border rounded-xl">

        <button id="btn-login" class="w-full bg-brand-dark text-white py-3 rounded-xl font-bold">
          Sign In
        </button>

        <button type="button" onclick="resendVerification()"
          class="text-sm text-brand-orange font-bold mt-3 hover:underline">
          Resend Verification Email
        </button>
      </form>

      <!-- SIGNUP -->
      <form id="signup-form" onsubmit="handleSignup(event)" class="space-y-4 hidden mt-4">

        <div class="grid grid-cols-2 gap-3">
          <label class="border p-3 rounded-xl cursor-pointer text-center">
            <input type="radio" name="role" value="restaurant" checked hidden>
            <i class="fa-solid fa-utensils"></i><br>Restaurant
          </label>
          <label class="border p-3 rounded-xl cursor-pointer text-center">
            <input type="radio" name="role" value="orphanage" hidden>
            <i class="fa-solid fa-child-reaching"></i><br>Orphanage
          </label>
        </div>

        <input id="signup-name" type="text" required placeholder="Organization Name"
          class="w-full px-4 py-3 bg-gray-50 border rounded-xl">

        <input id="signup-email" type="email" required placeholder="Email"
          class="w-full px-4 py-3 bg-gray-50 border rounded-xl">

        <input id="signup-password" type="password" required placeholder="Password"
          class="w-full px-4 py-3 bg-gray-50 border rounded-xl">

        <button id="btn-signup" class="w-full bg-brand-orange text-white py-3 rounded-xl font-bold">
          Create Account
        </button>
      </form>

      <p id="auth-message" class="text-center text-sm mt-4 hidden"></p>

    </div>
  </div>
</div>

<!-- FIREBASE LOGIC -->
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDB-qF6Ac93Tj3LR3DI6aTuUtkFNRMDai0",
  authDomain: "panel-9e1a6.firebaseapp.com",
  projectId: "panel-9e1a6"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

function toggleView(view) {
  document.getElementById('login-form').classList.toggle('hidden', view !== 'login');
  document.getElementById('signup-form').classList.toggle('hidden', view !== 'signup');
}

function showMessage(msg, type) {
  const el = document.getElementById('auth-message');
  el.textContent = msg;
  el.className = `block text-center mt-4 text-sm font-bold ${type === 'error' ? 'text-red-500' : 'text-green-600'}`;
}

async function handleSignup(e) {
  e.preventDefault();
  const name = signup-name.value;
  const email = signup-email.value;
  const password = signup-password.value;
  const role = document.querySelector('input[name="role"]:checked').value;

  const { user } = await auth.createUserWithEmailAndPassword(email, password);

  await user.sendEmailVerification({ url: location.origin + "/login" });

  await db.collection("users").doc(user.uid).set({
    name, email, role, isDisable: false,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  await auth.signOut();
  showMessage("Verify your email before logging in.", "success");
  toggleView('login');
}

async function handleLogin(e) {
  e.preventDefault();
  const email = login-email.value;
  const password = login-password.value;

  const { user } = await auth.signInWithEmailAndPassword(email, password);

  if (!user.emailVerified) {
    await auth.signOut();
    showMessage("Please verify your email first.", "error");
    return;
  }

  const doc = await db.collection("users").doc(user.uid).get();
  if (doc.data().isDisable) {
    await auth.signOut();
    showMessage("Account disabled.", "error");
    return;
  }

  const role = doc.data().role;
  location.href = role === "restaurant" ? "restaurant" : "orphanages";
}

async function resendVerification() {
  const user = auth.currentUser;
  if (!user) return alert("Login first");
  await user.sendEmailVerification();
  alert("Verification email sent!");
}
</script>

</body>
</html>
